<h1><%= @game.name %></h1>

<%= link_to "Edit", edit_game_path(@game), class: "btn btn-default" if can?(:update, @game) %>

<%# Admin view for game management. %>
<% if !@game.completed? && !@game.in_progress %>
	<p>This game has yet to be started.</p>
	
	<%= form_tag start_game_path(@game) do %>
		<strong>Team Fee</strong>
		<div class="input-group">
			<span class="input-group-addon">$</span>
			<%= text_field_tag :team_fee, nil, value: number_with_precision(@game.suggested_team_fee, precision: 2), class: "form-control" %>
		</div>
		
		<%= submit_tag "Start", class: "btn btn-success btn-large" %>
	<% end %>
	
	<h2>Teams</h2>
	
	<% if @game.teams.count == 0 %>
		<p>This game does not have any teams yet.</p>
	<% else %>
		<p>
			The following teams are in this game.
			
			<%= link_to "Remove All Teams", remove_all_game_path(@game), method: :post, class: "btn btn-danger" %>
		</p>
		
		<% @game.teams.each_slice(6) do |team_block| %>
			<div class="row">
				<% team_block.each do |team| %>
					<div class="col-md-2">
						<%= image_tag team.logo_url, width: "100%" if team.logo_url %>

						<h4><%= link_to team.name, team %></h4>

						<%= form_tag remove_game_path(@game) do %>
							<%= hidden_field_tag :name, team.name %>

							<%= submit_tag "Remove", class: "btn btn-danger" %>
						<% end %>

						<%= form_tag terminators_team_path(team) do %>
							<%= team.participations.find_by(game_id: @game.id).terminators ? "Terminators" : "Not terminators" %>

							<br>

							<%= hidden_field_tag :game_id, @game.id %>
							<%= submit_tag "Toggle", class: "btn btn-default" %>
						<% end %>
					</div>
				<% end %>
			</div>
		<% end %>
	<% end %>

	<h3>Add Team</h3>

	<% unless Team.not_in_game(@game).empty? %>
		<p>
			The following teams are not currently in this game.

			<%= link_to "Add All Teams", add_all_game_path(@game), method: :post, class: "btn btn-success" %>
		</p>
	<% else %>
		<p>All teams are currently in this game.</p>
	<% end %>

	<%# All of the teams that are not in this game. %>
	<% Team.not_in_game(@game).each_slice(6) do |team_block| %>
		<div class="row">
			<% team_block.each do |team| %>
				<div class="col-md-2">
					<%= image_tag team.logo_url, width: "100%" if team.logo_url %>

					<h4><%= link_to team.name, team %></h4>
					
					<%= form_tag add_game_path(@game) do %>
						<%= hidden_field_tag :name, team.name %>

						<%= submit_tag "Add", class: "btn btn-success" %>
					<% end %>
				</div>
			<% end %>
		</div>
	<% end %>
<% elsif @game.in_progress %>
	<p>This game is currently in progress.</p>

	<h2>Teams</h2>

	<h3>Remaining</h3>

	<% @game.remaining_teams.sort_by { |team| team.alive_members.count }.each_slice(6) do |team_block| %>
		<div class="row">
			<% team_block.each do |team| %>
				<div class="col-md-2">
					<%= image_tag team.logo_url, width: "100%" if team.logo_url %>

					<h4><%= link_to team.name, team %></h4>

					<p><%= team.alive_members.count %> / <%= team.members.count %> members are still alive.</p>
					<p>
						This team is currently <%= team.out_of_town? ? "out-of-town" : "in town" %>.
						<% if team.out_of_town? %>
							<%= precise_distance_of_time_in_words_to_now(team.remaining_out_of_town_end, no_time: true).capitalize %> left until termination.
						<% else %>
							All members must collectively be out-of-town for <%= precise_distance_of_time_in_words_to_now team.remaining_out_of_town_end, no_time: true %> for termination to occur.
						<% end %>
					</p>
					<p><%= link_to "Reset Out-Of-Town Hours", reset_out_of_town_hours_team_path(team), method: :post, class: "btn btn-default btn-sm", style: "white-space: normal", data: { confirm: "Are you sure?" } %></p>
					
					<p><%= precise_distance_of_time_in_words_to_now(team.participation.termination_at, no_time: true) %> left before autotermination.</p>
					<p><%= link_to "Reset Autotermination Time", reset_termination_at_team_path(team), method: :post, class: "btn btn-default btn-sm", style: "white-space: normal", data: { confirm: "Are you sure?" } %></p>
				</div>
			<% end %>
		</div>
	<% end %>

	<% if @eliminated_teams.count > 0 %>
		<h3>Eliminated</h3>
		
		<% @eliminated_teams.each_slice(6) do |team_block| %>
			<div class="row">
				<% team_block.each do |team| %>
					<div class="col-md-2">
						<%= image_tag team.logo_url, width: "100%" if team.logo_url %>

						<h4><%= link_to team.name, team %></h4>

						<p>Eliminated on <%= team.eliminated_at.in_time_zone.strftime "%b %-d at %l:%M %p" %></p>

						<p><%= link_to "Revive", revive_team_path(team), method: :post, class: "btn btn-default", data: { confirm: "Are you sure?  This will revive ALL members on this team." } %></p>
					</div>
				<% end %>
			</div>
		<% end %>
	<% end %>

	<h2>Contracts</h2>

	<% if @contract_order_teams.count == 2 %>
		<%= link_to @contract_order_teams.first.name, @contract_order_teams.first %>
		<%= glyphicon "arrow-left" %><%= glyphicon "arrow-right" %>
		<%= link_to @contract_order_teams.last.name, @contract_order_teams.last %>
	<% else %>
		<% @contract_order_teams.each do |team| %>
			<%= link_to team.name, team %>
			<%= glyphicon "arrow-right" %>
		<% end %>
		<%= link_to @contract_order_teams.first.name, @contract_order_teams.first %>
	<% end %>
<% elsif @game.completed? %>
	<p>The prize money total for this game was $<%= number_with_precision @game.prize_money, precision: 2 %>.</p>
	
	<h2>
		Winner:
		<%= link_to_if_can_read @game.winner.name, @game.winner %>
		
		<ul>
			<% @game.winner.members(@game.id).each do |member| %>
				<li><%= link_to_if_can_read member.name, member %></li>
			<% end %>
		</ul>
	</h2>

	<p>
		The other teams were placed:

		<%# Reverse sort_by and start at 2. %>
		<ol>
			<% @game.teams.select { |team| !team.terminators?(@game.id) && team.id != @game.winner.id? }.sort_by { |team| team.eliminated_at(@game.id) }.each do |team| %>
				<li><%= link_to_if_can_read team.name, team %></li>

				<ul>
					<% team.members(@game.id).each do |member| %>
						<li><%= link_to_if_can_read member.name, member %></li>
					<% end %>
				</ul>
			<% end %>
		</ol>
	</p>
<% end %>

<p>
	<div class="btn-group">
		<%= link_to "View Events", events_game_path(@game), class: "btn btn-default" %>
		<%= link_to "Manage Team Fees", team_fees_game_path(@game), class: "btn btn-default" if can?(:team_fees, @game) %>
	</div>
</p>
