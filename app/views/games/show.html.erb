<h1><%= @game.name %></h1>

<%= link_to "Edit", edit_game_path(@game), class: "btn btn-default" if can?(:update, @game) %>

<%# Admin view for game management. %>
<% if !@game.completed? && !@game.in_progress %>
	<p>This game has yet to be started.</p>
	
	<%= form_tag start_game_path(@game) do %>
		<strong>Team Fee</strong>
		<div class="input-group">
			<span class="input-group-addon">$</span>
			<%= text_field_tag :team_fee, nil, value: number_with_precision(@game.suggested_team_fee, precision: 2), class: "form-control" %>
		</div>
		
		<%= submit_tag "Start", class: "btn btn-success btn-large" %>
	<% end %>
	
	<h2>Teams</h2>
	
	<% if @game.teams.count == 0 %>
		<p>This game does not have any teams yet.</p>
	<% else %>
		<p>
			The following teams are in this game.
			
			<%= link_to "Remove All Teams", remove_all_game_path(@game), method: :post, class: "btn btn-danger" %>
		</p>
		
		<% @game.teams.each_slice(6) do |team_block| %>
			<div class="row">
				<% team_block.each do |team| %>
					<div class="col-md-2">
						<%= image_tag team.logo_url, width: "100%" if team.logo_url %>

						<h4><%= link_to team.name, team %></h4>

						<%= form_tag remove_game_path(@game) do %>
							<%= hidden_field_tag :name, team.name %>

							<%= submit_tag "Remove", class: "btn btn-danger" %>
						<% end %>

						<%= form_tag terminators_team_path(team) do %>
							<%= team.participations.find_by(game_id: @game.id).terminators ? "Terminators" : "Not terminators" %>

							<br>

							<%= hidden_field_tag :game_id, @game.id %>
							<%= submit_tag "Toggle", class: "btn btn-default" %>
						<% end %>
					</div>
				<% end %>
			</div>
		<% end %>
	<% end %>

	<h3>Add Team</h3>

	<% unless Team.not_in_game(@game).empty? %>
		<p>
			The following teams are not currently in this game.

			<%= link_to "Add All Teams", add_all_game_path(@game), method: :post, class: "btn btn-success" %>
		</p>
	<% else %>
		<p>All teams are currently in this game.</p>
	<% end %>

	<%# All of the teams that are not in this game. %>
	<% Team.not_in_game(@game).each_slice(6) do |team_block| %>
		<div class="row">
			<% team_block.each do |team| %>
				<div class="col-md-2">
					<%= image_tag team.logo_url, width: "100%" if team.logo_url %>

					<h4><%= link_to team.name, team %></h4>
					
					<%= form_tag add_game_path(@game) do %>
						<%= hidden_field_tag :name, team.name %>

						<%= submit_tag "Add", class: "btn btn-success" %>
					<% end %>
				</div>
			<% end %>
		</div>
	<% end %>
<% elsif @game.in_progress %>
	<p>This game is currently in progress.</p>

	<h2>Teams</h2>

	<h3>Remaining</h3>

	<% @game.remaining_teams.sort_by { |team| team.alive_members.count }.each_slice(6) do |team_block| %>
		<div class="row">
			<% team_block.each do |team| %>
				<div class="col-md-2">
					<%= image_tag team.logo_url, width: "100%" if team.logo_url %>

					<h4><%= link_to team.name, team %></h4>

					<p><%= team.alive_members.count %> / 4 members are still alive.</p>
					<p><%= team.remaining_kill_time_format.capitalize %> left before autotermination.</p>
				</div>
			<% end %>
		</div>
	<% end %>

	<% if @eliminated_teams.count > 0 %>
		<h3>Eliminated</h3>
		
		<% @eliminated_teams.each_slice(6) do |team_block| %>
			<div class="row">
				<% team_block.each do |team| %>
					<div class="col-md-2">
						<%= image_tag team.logo_url, width: "100%" if team.logo_url %>

						<h4><%= link_to team.name, team %></h4>

						<% if can?(:revive, Team) %>
							<p><%= link_to "Revive", revive_team_path(team), method: :post, class: "btn btn-default", data: { confirm: "Are you sure?  This will revive ALL members on this team." } %></p>
						<% end %>
					</div>
				<% end %>
			</div>
		<% end %>
	<% end %>

	<h2>Contracts</h2>

	<% if @contract_order_teams.count == 2 %>
		<%= link_to @contract_order_teams.first.name, @contract_order_teams.first %>
		<%= glyphicon "arrow-left" %><%= glyphicon "arrow-right" %>
		<%= link_to @contract_order_teams.last.name, @contract_order_teams.last %>
	<% else %>
		<% @contract_order_teams.each do |team| %>
			<%= link_to team.name, team %>
			<%= glyphicon "arrow-right" %>
		<% end %>
		<%= link_to @contract_order_teams.first.name, @contract_order_teams.first %>
	<% end %>
	
	<p><%= link_to "View Events", events_game_path(@game), class: "btn btn-default" %></p>
<% elsif @game.completed? %>
	<h2>
		Winner:
		<%= @game.winner.name %>
	</h2>
<% end %>
